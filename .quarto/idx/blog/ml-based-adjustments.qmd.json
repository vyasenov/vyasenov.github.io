{"title":"ML-Based Regression Adjustments in Randomized Experiments","markdown":{"yaml":{"title":"ML-Based Regression Adjustments in Randomized Experiments","date":"2023-08-01","categories":["machine learning","randomized experiments"]},"headingText":"Background","containsRefs":false,"markdown":"\n\n\nRandomized experiments are the gold standard when interested in measuring causal relationships with data. In settings with small treatment effects or underpowered designs, a major focus falls on decreasing the variance. In simple low-dimensional settings a common attempt to do that is to include a bunch of covariates and their interaction with the treatment variable in an OLS regression. Under [standard assumptions](https://projecteuclid.org/journals/annals-of-applied-statistics/volume-7/issue-1/Agnostic-notes-on-regression-adjustments-to-experimental-data--Reexamining/10.1214/12-AOAS583.full), the coefficient on the treatment variable is still asymptotically unbiased (albeit not in finite samples) and including the interactions guarantees that this estimator does not have higher asymptotic variance than the simple difference-in-means.\n\nIn high-dimensional settings, however, this can easily lead to overfitting and new tools for variance reduction are needed. In this article, I will focus on two ways Machine Learning (ML) can be helpful with this problem when we have access to a bunch of covariates.  In the first set of methods, we use a ML algorithm (such as the lasso) to directly estimate the treatment effect. Alternatively, we can first use ML to predict the outcome and then feed that prediction in an OLS regression.\n\nA helpful benchmark with which to compare these methods is the simple (non-parametric) difference-in-means estimator. Under certain conditions, both approaches guarantee smaller or equal variance.\n\n## Notation\n\nI use $\\bar{Y}^T$ and $\\bar{Y}^C$ to denote the sample average outcomes for the treatment and control groups respectively. $X$ is the covariate vector and its deviations from the average are $\\tilde{X}$. The benchmark estimator can be expressed as:\n\n  $$\\hat{ATE}^{simple} = \\bar{Y}^T - \\bar{Y}^C.$$\n\n## A Closer Look\n\nBroadly speaking, there are two ML Methods for Variance Reduction.\n\n### Using ML Regression Directly\n\nThe simplest and most natural way to incorporate covariates is to add them to a linear model (along with the treatment variable and their interactions with the treatment variable). [Bloniarz et al. (2015)](https://www.pnas.org/doi/abs/10.1073/pnas.1510506113) show we can directly use Lasso regression instead of OLS.\n\nTo guarantee that the lasso does not omit the treatment variable, we can run two separate regressions, one for each (treatment) group. Then the estimator can be formulated as:\n\n$$\\hat{ATE}^{lasso} = (\\bar{Y}^T-\\tilde{X}^T\\beta^{T}_{lasso}) - (\\bar{Y}^C-\\tilde{X}^C\\beta^{C}_{lasso}),$$\n\nwhere $\\beta^{i}_{lasso}$ is the coefficient vector from the lasso regressions on observations in group $i\\in\\{T,C\\}$. The authors also give a conservative formula for computing the variance of $\\hat{ATE}^{lasso}$. When the two lasso regressions select different sets of covariates (which is probably common in practice), this is no longer guaranteed to yield equal or lower asymptotic variance compared to the benchmark.\n\n::: {.callout-note title=\"Algorithm:\"}\n1. For the treatment and control groups separately, run lasso regression of $Y$ on $\\tilde{X}$ go get $\\hat{\\beta}^T_{lasso}$ and $\\hat{\\beta}^C_{lasso}$.\n2. Calculate the treatment effect estimate $\\hat{ATE}^{lasso}$ using the above formula.\n3. Calculate the estimate of the variance of $\\hat{ATE}^{lasso}$ using the formula in Blonarz et al. (2015).\n:::\n\nThe authors also propose the [lasso+OLS estimator](https://projecteuclid.org/journals/bernoulli/volume-19/issue-2/Least-squares-after-model-selection-in-high-dimensional-sparse-models/10.3150/11-BEJ410.full) which first uses $L1$ regularization as above to select the covariates and then plugs those in OLS to get the treatment effect estimate.\n\nA similar idea has also been studied by [Wager et al (2016)](https://www.pnas.org/doi/abs/10.1073/pnas.1614732113). They show that when additionally, assuming Gaussian data (along with a bunch of regularity assumptions), we can use any “risk consistent” ML estimator such as ridge, elastic net, etc. “Risk consistent” here means as we give the algorithm more data, it gets closer to the truth. The lower the risk the higher the variance reduction gains compared to the simple difference-in-means estimator. The authors also propose a simple cross-fitting approach to calculate confidence intervals.\n\n::: {.callout-note title=\"Algorithm:\"}\n1. Split the data into $k$ equal sized folds.\n2. For each fold $k$:\n  i. calculate $\\bar{Y}^k, \\tilde{X}^k$.\n  ii. get the coefficients $\\hat{\\beta}_{lasso}^{-k}$ based on regressions on all other $k-1$ folds.\n  iii. combine both quantities and calculate $\\hat{ATE}^{lasso}$.\n  iv. calculate its standard error.\n3. Get the final estimates $\\hat{ATE}^{lasso}$ and its standard error by taking weighted averages across all $k$ folds.\n:::\n\nThis concludes the discussion of using a ML-type linear regression model to reduce the variance in A/B tests. Let’s now move on to the second method.\n\n### Using ML Regression Indirectly\n\nAn [alternative approach](https://proceedings.neurips.cc/paper/2021/hash/488b084119a1c7a4950f00706ec7ea16-Abstract.html) first uses ML to predict $Y$ and then plugs that prediction into an OLS regression of the outcome on the treatment variable. One can then use cross-fitting to do the prediction which ensures the “naïve” OLS confidence intervals remain valid. The authors call this procedure MLRATE (machine learning regression-adjusted treatment effect estimator).\n\nHere is a rough version of the algorithm:\n\n::: {.callout-note title=\"Algorithm:\"}\n1. Split the data in $k$ equal-sized folds.\n2. For each fold $k$:\n  i. Predict $Y$ by applying a ML algorithm to all other $k-1$ folds. Call this prediction $\\bar{Y}_k$.\n3. Get a final prediction $\\bar{Y}=\\sum_k\\bar{Y}_k$.\n4. Run OLS of $Y$ on $T$, $\\bar{Y}_k$ and $(\\bar{Y}_k-\\bar{Y}) \\times T$ and use the associated standard errors and $p$-values.\n:::\n\n## Bottom Line\n\n- Regression adjustments are a commonly used tool to reduce variance in A/B tests.\n\n- The machine learning toolbox offers possibly more powerful algorithms in this space.\n\n- There are two main ML approaches. Both can be shown under certain conditions to be at least as good as the simple difference-in-means estimator.\n\n- The first approach uses ML regression algorithms directly.\n\n- The second method, instead, uses ML to predict the outcome and adds that in an OLS regression.\n\n## References\n\nBelloni, A., & Chernozhukov, V. (2013). Least squares after model selection in high-dimensional sparse models. Bernoulli 19(2): 521-547\n\nBloniarz, A., Liu, H., Zhang, C. H., Sekhon, J. S., & Yu, B. (2016). Lasso adjustments of treatment effect estimates in randomized experiments. Proceedings of the National Academy of Sciences, 113(27), 7383-7390.\n\nGuo, Y., Coey, D., Konutgan, M., Li, W., Schoener, C., & Goldman, M. (2021). Machine learning for variance reduction in online experiments. Advances in Neural Information Processing Systems, 34, 8637-8648.\n\nLin, W. (2013). Agnostic notes on regression adjustments to experimental data: Reexamining Freedman’s critique. Ann. Appl. Stat. 7(1): 295-318\n\nList, J. A., Muir, I., & Sun, G. K. (2022). Using Machine Learning for Efficient Flexible Regression Adjustment in Economic Experiments (No. w30756). National Bureau of Economic Research.\n\nNegi, A., & Wooldridge, J. M. (2021). Revisiting regression adjustment in experiments with heterogeneous treatment effects. Econometric Reviews, 40(5), 504-534.\n\nPoyarkov, A., Drutsa, A., Khalyavin, A., Gusev, G., & Serdyukov, P. (2016, August). Boosted decision tree regression adjustment for variance reduction in online controlled experiments. In Proceedings of the 22nd ACM SIGKDD International Conference on Knowledge Discovery and Data Mining (pp. 235-244).\n\nWager, S., Du, W., Taylor, J., & Tibshirani, R. J. (2016). High-dimensional regression adjustments in randomized experiments. Proceedings of the National Academy of Sciences, 113(45), 12673-12678.","srcMarkdownNoYaml":"\n\n## Background\n\nRandomized experiments are the gold standard when interested in measuring causal relationships with data. In settings with small treatment effects or underpowered designs, a major focus falls on decreasing the variance. In simple low-dimensional settings a common attempt to do that is to include a bunch of covariates and their interaction with the treatment variable in an OLS regression. Under [standard assumptions](https://projecteuclid.org/journals/annals-of-applied-statistics/volume-7/issue-1/Agnostic-notes-on-regression-adjustments-to-experimental-data--Reexamining/10.1214/12-AOAS583.full), the coefficient on the treatment variable is still asymptotically unbiased (albeit not in finite samples) and including the interactions guarantees that this estimator does not have higher asymptotic variance than the simple difference-in-means.\n\nIn high-dimensional settings, however, this can easily lead to overfitting and new tools for variance reduction are needed. In this article, I will focus on two ways Machine Learning (ML) can be helpful with this problem when we have access to a bunch of covariates.  In the first set of methods, we use a ML algorithm (such as the lasso) to directly estimate the treatment effect. Alternatively, we can first use ML to predict the outcome and then feed that prediction in an OLS regression.\n\nA helpful benchmark with which to compare these methods is the simple (non-parametric) difference-in-means estimator. Under certain conditions, both approaches guarantee smaller or equal variance.\n\n## Notation\n\nI use $\\bar{Y}^T$ and $\\bar{Y}^C$ to denote the sample average outcomes for the treatment and control groups respectively. $X$ is the covariate vector and its deviations from the average are $\\tilde{X}$. The benchmark estimator can be expressed as:\n\n  $$\\hat{ATE}^{simple} = \\bar{Y}^T - \\bar{Y}^C.$$\n\n## A Closer Look\n\nBroadly speaking, there are two ML Methods for Variance Reduction.\n\n### Using ML Regression Directly\n\nThe simplest and most natural way to incorporate covariates is to add them to a linear model (along with the treatment variable and their interactions with the treatment variable). [Bloniarz et al. (2015)](https://www.pnas.org/doi/abs/10.1073/pnas.1510506113) show we can directly use Lasso regression instead of OLS.\n\nTo guarantee that the lasso does not omit the treatment variable, we can run two separate regressions, one for each (treatment) group. Then the estimator can be formulated as:\n\n$$\\hat{ATE}^{lasso} = (\\bar{Y}^T-\\tilde{X}^T\\beta^{T}_{lasso}) - (\\bar{Y}^C-\\tilde{X}^C\\beta^{C}_{lasso}),$$\n\nwhere $\\beta^{i}_{lasso}$ is the coefficient vector from the lasso regressions on observations in group $i\\in\\{T,C\\}$. The authors also give a conservative formula for computing the variance of $\\hat{ATE}^{lasso}$. When the two lasso regressions select different sets of covariates (which is probably common in practice), this is no longer guaranteed to yield equal or lower asymptotic variance compared to the benchmark.\n\n::: {.callout-note title=\"Algorithm:\"}\n1. For the treatment and control groups separately, run lasso regression of $Y$ on $\\tilde{X}$ go get $\\hat{\\beta}^T_{lasso}$ and $\\hat{\\beta}^C_{lasso}$.\n2. Calculate the treatment effect estimate $\\hat{ATE}^{lasso}$ using the above formula.\n3. Calculate the estimate of the variance of $\\hat{ATE}^{lasso}$ using the formula in Blonarz et al. (2015).\n:::\n\nThe authors also propose the [lasso+OLS estimator](https://projecteuclid.org/journals/bernoulli/volume-19/issue-2/Least-squares-after-model-selection-in-high-dimensional-sparse-models/10.3150/11-BEJ410.full) which first uses $L1$ regularization as above to select the covariates and then plugs those in OLS to get the treatment effect estimate.\n\nA similar idea has also been studied by [Wager et al (2016)](https://www.pnas.org/doi/abs/10.1073/pnas.1614732113). They show that when additionally, assuming Gaussian data (along with a bunch of regularity assumptions), we can use any “risk consistent” ML estimator such as ridge, elastic net, etc. “Risk consistent” here means as we give the algorithm more data, it gets closer to the truth. The lower the risk the higher the variance reduction gains compared to the simple difference-in-means estimator. The authors also propose a simple cross-fitting approach to calculate confidence intervals.\n\n::: {.callout-note title=\"Algorithm:\"}\n1. Split the data into $k$ equal sized folds.\n2. For each fold $k$:\n  i. calculate $\\bar{Y}^k, \\tilde{X}^k$.\n  ii. get the coefficients $\\hat{\\beta}_{lasso}^{-k}$ based on regressions on all other $k-1$ folds.\n  iii. combine both quantities and calculate $\\hat{ATE}^{lasso}$.\n  iv. calculate its standard error.\n3. Get the final estimates $\\hat{ATE}^{lasso}$ and its standard error by taking weighted averages across all $k$ folds.\n:::\n\nThis concludes the discussion of using a ML-type linear regression model to reduce the variance in A/B tests. Let’s now move on to the second method.\n\n### Using ML Regression Indirectly\n\nAn [alternative approach](https://proceedings.neurips.cc/paper/2021/hash/488b084119a1c7a4950f00706ec7ea16-Abstract.html) first uses ML to predict $Y$ and then plugs that prediction into an OLS regression of the outcome on the treatment variable. One can then use cross-fitting to do the prediction which ensures the “naïve” OLS confidence intervals remain valid. The authors call this procedure MLRATE (machine learning regression-adjusted treatment effect estimator).\n\nHere is a rough version of the algorithm:\n\n::: {.callout-note title=\"Algorithm:\"}\n1. Split the data in $k$ equal-sized folds.\n2. For each fold $k$:\n  i. Predict $Y$ by applying a ML algorithm to all other $k-1$ folds. Call this prediction $\\bar{Y}_k$.\n3. Get a final prediction $\\bar{Y}=\\sum_k\\bar{Y}_k$.\n4. Run OLS of $Y$ on $T$, $\\bar{Y}_k$ and $(\\bar{Y}_k-\\bar{Y}) \\times T$ and use the associated standard errors and $p$-values.\n:::\n\n## Bottom Line\n\n- Regression adjustments are a commonly used tool to reduce variance in A/B tests.\n\n- The machine learning toolbox offers possibly more powerful algorithms in this space.\n\n- There are two main ML approaches. Both can be shown under certain conditions to be at least as good as the simple difference-in-means estimator.\n\n- The first approach uses ML regression algorithms directly.\n\n- The second method, instead, uses ML to predict the outcome and adds that in an OLS regression.\n\n## References\n\nBelloni, A., & Chernozhukov, V. (2013). Least squares after model selection in high-dimensional sparse models. Bernoulli 19(2): 521-547\n\nBloniarz, A., Liu, H., Zhang, C. H., Sekhon, J. S., & Yu, B. (2016). Lasso adjustments of treatment effect estimates in randomized experiments. Proceedings of the National Academy of Sciences, 113(27), 7383-7390.\n\nGuo, Y., Coey, D., Konutgan, M., Li, W., Schoener, C., & Goldman, M. (2021). Machine learning for variance reduction in online experiments. Advances in Neural Information Processing Systems, 34, 8637-8648.\n\nLin, W. (2013). Agnostic notes on regression adjustments to experimental data: Reexamining Freedman’s critique. Ann. Appl. Stat. 7(1): 295-318\n\nList, J. A., Muir, I., & Sun, G. K. (2022). Using Machine Learning for Efficient Flexible Regression Adjustment in Economic Experiments (No. w30756). National Bureau of Economic Research.\n\nNegi, A., & Wooldridge, J. M. (2021). Revisiting regression adjustment in experiments with heterogeneous treatment effects. Econometric Reviews, 40(5), 504-534.\n\nPoyarkov, A., Drutsa, A., Khalyavin, A., Gusev, G., & Serdyukov, P. (2016, August). Boosted decision tree regression adjustment for variance reduction in online controlled experiments. In Proceedings of the 22nd ACM SIGKDD International Conference on Knowledge Discovery and Data Mining (pp. 235-244).\n\nWager, S., Du, W., Taylor, J., & Tibshirani, R. J. (2016). High-dimensional regression adjustments in randomized experiments. Proceedings of the National Academy of Sciences, 113(45), 12673-12678."},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../code/styles.css"],"toc":true,"include-in-header":[{"text":"<script src=\"../code/open-links-new-tab.js\"></script>\n"}],"filters":["code-insertion"],"output-file":"ml-based-adjustments.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.24","resources":["../code/open-links-new-tab.js"],"theme":{"light":"cosmo","dark":"cyborg"},"header-includes":["<script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=680ee8d89f7a510019a96bcf&product=inline-share-buttons' async='async'></script>"],"page-layout":"full","includes":{"after-body":["../_includes/comments.html"]},"insert-before-post":"_sharebuttons.md","title":"ML-Based Regression Adjustments in Randomized Experiments","date":"2023-08-01","categories":["machine learning","randomized experiments"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}